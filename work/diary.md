# 2023/01/26

AHC用マシンを起動して疎通確認。
前回はネットワークがつながらず本番中にもトラブルシューティングする羽目になったが今回は特に問題なく。

VScodeのupdateも特に走らず問題なく終了。

# 2023/01/27

「Psyhoさんによるヒューリスティック・ボットコンテストのための無料Tips
(https://ozy4dm.hateblo.jp/entry/2022/12/22/162046)
を読み返す。

# 2023/01/28

GitHubでレポジトリを作成。Privateが無料アカウントでも出来ることを知らなかった。
今までローカルレポジトリでやっていたがPCをまたぐと不便なので今回はGitHubに寄せる予定。

12時にスタート。昼ご飯を作りつつ問題文を眺める。

スケジュール問題風が日にちに依存する要素はないので辺集合の分割問題。

平面グラフというのがポイントか。
連結じゃなくなると不満度が10^9になってしまうのでまずは連結性をできるだけ保った分割を目指すことになりそう。

ぱっと思いつくのは平面グラフなので出来るだけ「遠い」辺を選べば連結性は保てそうということ。

テスト用に10000ケースをダウンロードして

・pre test: 50ケース
・sys test: 2000ケース
・stress test: 10000ケース

を作成。

Graphクラスを作成。工事する辺集合を決めるたびに全点でダイクストラをやっているのでここは要改善ポイント。

SqDistSchedulerを作成。
・距離はユークリッド距離の二乗
・未工事でまだ選らんでいない辺のうち、すでに選らだ辺との最小距離が最大
で選んでいく方法。


seed=7552が「平均より難し目」(N=764, M=1767, D=6, K=548)でテスト。

Graphクラスで距離の初期化を忘れていたりN(N-1)で割るのを忘れていたりしたが、Visualizerの結果と合った。

1辺だけ除いた場合のコスト増分をすべての辺に対して合計したものがコストの下界になるのでそれを求めるプログラムを作成。
1問当たり1分程度かかるため夜とかをうまく使う必要がある。

ダイクストラをBFSに変えたがほとんど変わらず。priority_queue内のノード数が多くならないからか。
夜にコスト下界をsys testで走らせて終了。

# 2023/01/29

コスト下界は2時間ほどで終了していた。

高速化のためにedge indexを持つようにしたらなぜかテストケースの結果が変わる…で少し悩むが
pre, sys, stressがそれぞれ包含されるようにはなっているが、先頭から並んでいるわけではないので
stressの先頭50件がpreになっているわけではなかったのが原因。

辺の集合をbitsetで持つようにして、辺削除時の最短路再計算を影響のあるノードについてのみ行うように変更。
11%高速化。

ここで初submit。平均73.5M。ちょっとコストは低めな印象。簡単な問題が集まっているのかもしれない。
この時点で相対スコア24Gくらいで111位。

辺(i, j)を削除した時の迂回路を出しておいて、工事計画を作るときに極力、迂回路を使わないことで非連結になるのを抑制するようにした。
sys test相当で平均コストが231Mから89Mに改善。

これをsubmitして平均コスト46.6M。
この時点で相対スコア25.6Gくらいで112位。コストを下げても相対スコアが上がらないというのは
非連結をなくすというのはトップ層は出来ていてて連結な上で経路増分の最小化勝負になっているということ。

迂回路回避は結果を可視化すると

・非連結なノードペア数の削減には貢献
・非連結の発生自体はあまり防げていない

になっている。相対スコアが伸びなかった理由もこれかもしれない。
（非連結な問題での改善はできているが非連結自体は解消できていないので上位との差が大きい。）

連結性を保つために日ごとに工事しない辺を固定させてみたが最終日に残りの辺を工事すると連結性が崩れるという問題があり
ちゃんと考えないとダメそう。
⇒連結性を焼きなまし法で。
 
1. U E_d=Mを維持しながらF_dの連結性をあげる
2. F_dの連結性を維持しながらMに近づける

の2つ考えて1.だとE_dがMの分割になり距離最小化の自由度が下がる(固定される)ため2を優先することに。

連結性を保つ集合の算出が完了。大きなバグもなくスムーズ。
焼きなましを使ったがほぼ貪欲。反復回数も100だと非連結な日が残るが300で解消。念のため500に設定。

差分計算もしていなくて性能的には改善箇所が残っているが最大でも450msくらいなので最後どうしても…というところでやることにしよう。

連結性を保つようにしつつSqDistSchedulerでスケジュールを組むとついに非連結なノードペアが0になった。
sys testで平均コストが89Mから21Mまで一気に改善。ようやくスタートラインに立てた感じ。

これをsubmitして平均コスト19.2M。順位表では25.5Gで相対スコアはあまり変わっていないけど72位。
非連結な状態を解消できるかどうかの壁が存在するのかも。

後続のアイディアは

・経路増分の最小化で焼きなまし
　・計算時間が厳しい
　　・近似計算
　　・グループ化
・連結性で工事可能日=1が互いに迂回路になる辺を減らす
・プロファイル
・コスト下界との比較

あたり。

今日はコスト下界のstress test分を回して終了。

# 2023/01/30

コスト下界は迂回路と最短路として何回使われていれば出せる気がするので確認しよう。

次の目標は簡単な問題
・EdgeDensityが大
・Dが大
でコスト下界を達成すること。

コスト下界のstress test分は9時間45分かけて昼前に終了。

コスト下界と比べると平均で1.12、最大1.60になっている。

これだと順位表の結果と合わない。相対スコアで25G/50Gくらいなので
参加者の最小コスト/自分のコスト=0.5でコストは参加者最小の2倍程度になっているはずだが
コスト下界から1.6倍しか離れていないことになる。

コスト下界は勘違いをしていた。
1辺ずつ工事していくのがコスト最小になると思ったがある辺を削除した時に各ノードの最短路木が変わり
もう１辺削除した時に単独でその辺を削除した時より少ないコストになることがある。

下界というより目標値の方が良いかも。
順位表からの情報から不整合に気づいて、小さなサンプルで全探索して反例を見つけることができた。
トップ層はずっと先ということだが、この不整合は腹落ちできた。この動きが出来たのは良かった。

あと問題の理解も深まって基本的に離れた辺を削除していった方がいいと思ったが、
局所的には同時に削除した方が良いケースもありこれをどう組み込むか…がポイントになりそう。

まずは「目標値」を目指すことに。
迂回路集合に工事辺を入れないように焼きなましを実装。

考察から実装して動き出すまで2時間位でスムーズ。
実は焼きなまし部分はかなり高速で0.1秒もかかっていないが、正確なコストを出すところで秒単位で時間がかかっている。
解を出す部分と正確なコストを出す部分は分離した方がいいかもしれない。

Kがceil(M/D)ギリギリの時、Kを越える計画になるバグあったのでコスト関数と遷移を修正。
この段階で回すとsys相当で3.4%ほど改善。

焼きなましの回数を伸ばしてもスコアはあまり変わらない(0.7%改善)のでログを確認して連結性も手を入れた方が良いかもしれない。

# 2023/01/31

Psyhoさんがすべてのテストケースで1位になり50Gをたたき出していた。これは凄い。
ぱっとは気づきにくいが、普遍的なケースで成立する良いやり方がありそう。

仕事が終わったのが9時半ごろでそこから再開。
迂回路集合上の工事辺の数がおかしいようでデバッグ。
迂回路集合を工事辺が乗らない状態が作れるようになってきた。

ただ、迂回路集合を通らないからと言って必ずしも目標値にはならいようだ。
この辺りは最短路木についてもう少し考察なり実験をしないといけない。

連結性のところで工事可能日が1日の辺が迂回路集合に入るのを抑制するように調整。
コストは2000と結構高めにして反復回数も500 -> 1Kへ。

# 2023/02/01

連結性をコスト2000, 反復回数1Kにしてテスト。
あと工事計画側も迂回路の生成元を移す遷移も入れた。

sys test相当で19.57G -> 19.46Gと大分と改善幅は小さくなってきた。
これをsubmitして平均18.0Mで相対スコア23.45Gで138位。みんな大分と伸ばしている。
Psyhoさんが50Gなのも変わらず。

# アイディアメモ

## 辺集合を除去した場合の最短距離
辺集合を除いた場合の各点からの距離の総和を高速に求めたい。

* ノードごとに最短路木を持っておく
  * 削除する辺がその最短路木に含まれている場合にのみ最短路を再計算する

* 辺ごとに何回、最短路木に含まれているかを求めておき除くごとにう回路のコストから差分計算する(近似計算)

## 辺集合の選択

* 焼きなまし法(01/28)
  * 日別の辺集合
  * 日は最初緩めにしておく？

* 円内を領域にわけてそこから選択する辺の数を焼きなます？(01/28)

* 平面グラフ(01/28)
  * 双対グラフを考えられる。面に対する操作を考える？

## ToDo
* Visualizer/Generatorのコードを読む
* 工事可能な辺を生成する際の連結性判定を辺リストの前から見ているがランダムや辺の距離の短いもの順にするのを試す(01/29)
* Graphクラスを使いまわせるようにする(01/29)

* 連結性(01/29)
  * 工事可能な日が1日の辺同士が互いの迂回路になっていると迂回路が長くなる可能性あり
  * 連結性の時点でコストを与えておく？
  
  * 迂回路集合に入る辺の個数だけでなくて伸びる距離も考慮する

  * ランダムに全域木を作っているが最短路木をベースに作った方がよさそう

* 工事計画
  * 迂回路集合に入る辺の個数だけでなくて伸びる距離も考慮する

* 削除する辺の組み合わせによっては単独で削除した場合よりコストが少なくなることがある
  * その条件を考察する

* 元の最短路木から何回最短路に選ばれているか？辺を削除した時に影響のある最短路木は何か？を考察する

* 小さい問題で全列挙、機械学習を入れてみる

## 実施済

* 距離がユークリッド距離で定義されているのでダイクストラではなくBFSで求まるはず(1/28)
  * 距離を10^3かけて四捨五入しているため厳密には三角不等式が成立しないがほぼ同じ答えがでるはず。
  ⇒同じ答えにはなったが速度はほぼ同じ。priority_queue内のノード数がそこまで多くならないからか。

* 連結性が保てない場合のテスト(01/29)
* 賢いGreedy(01/28)
  * 辺ごとに除いた場合のう回路を求めておく
  * う回路を除かないように辺を追加していく

* コスト下界は迂回路と最短路から出せるハズ(01/30)
  * 各点の最短路木に対してその辺がない場合の迂回路による増分の和がその点でのコスト下界
  ⇒そうとも限らなさそう

* CostLBをtest_stressで実行(10時間程度) (01/28)

* 工事計画
  * 遷移に迂回路の生成元を加える
